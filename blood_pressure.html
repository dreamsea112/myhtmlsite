<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>血壓/用藥紀錄表</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; padding: 20px; background: #f5f5f5; }
        h1 { text-align: center; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 980px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background: #eee; }
        input { width: 100%; box-sizing: border-box; }
        input[type="number"] { width: 60px; text-align: center; }
        th:nth-child(5), td:nth-child(5) { min-width: 90px; }
        th:nth-child(6), td:nth-child(6) { min-width: 160px; }
        th:nth-child(7), td:nth-child(7) { min-width: 90px; }
        button { padding: 6px 10px; cursor: pointer; }
        .add-btn { margin-bottom: 10px; }
        #authLayer { position: fixed; inset: 0; background: rgba(245,245,245,0.95); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #authBox { background: white; padding: 20px; border: 1px solid #ccc; width: 300px; text-align: center; }
        .bp-high { background-color: #ffe5e5 !important; }
        .input-normal { border: 1px solid #ccc !important; } 
        .input-elevated { border: 2px solid #ffa726 !important; }
        .input-stage1 { border: 2px solid #ef5350 !important; }
        .input-stage2 { border: 2px solid #b71c1c !important; background-color: #fff9f9 !important; }
        #medReminder, #avgInfo { margin-bottom: 10px; text-align: center; color: #a00; font-weight: bold; }
        #stockReminder { margin-bottom: 10px; text-align: center; color: #e65100; font-weight: bold; background: #fff3e0; padding: 5px; border-radius: 4px; display: none; }
        #chartLayer, #calendarLayer { position: fixed; inset: 0; background: white; display: none; flex-direction: column; padding: 20px; z-index: 999; overflow-y: auto; }
        .filter-section { text-align: center; margin-bottom: 15px; }
        #pdfTemplate { display: none; padding: 40px; color: #333; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; max-width: 600px; margin: 0 auto; width: 100%; }
        .cal-date-cell { aspect-ratio: 1 / 1; border: 1px solid #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
    </style>
</head>
<body>

<div id="authLayer">
    <div id="authBox">
        <h3>請輸入密碼</h3>
        <input type="password" id="authPwd" placeholder="密碼">
        <button onclick="verifyPassword()">驗證</button>
        <div id="authMsg"></div>
    </div>
</div>

<div id="chartLayer">
    <div style="text-align:right;"><button onclick="toggleChart(false)">關閉分析面板</button></div>
    <div id="chartsContainer" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; flex:1;">
        <div style="height:300px;"><canvas id="bpChart"></canvas></div>
        <div style="height:300px;"><canvas id="weekChart"></canvas></div>
        <div style="height:300px; grid-column: span 2;"><canvas id="distributionChart"></canvas></div>
    </div>
</div>

<div id="calendarLayer">
    <div style="text-align:right;"><button onclick="toggleCalendar(false)">關閉月曆</button></div>
    <div style="text-align:center; margin-bottom:20px;">
        <button onclick="changeCalMonth(-1)">上個月</button>
        <h2 id="calTitle" style="display:inline; margin:0 20px;"></h2>
        <button onclick="changeCalMonth(1)">下個月</button>
    </div>
    <div id="calGrid" class="cal-grid"></div>
</div>

<div id="stockReminder"></div>
<div id="medReminder" style="display:none;">今日尚未勾選任何已服藥紀錄</div>
<div id="avgInfo" style="display:none;"></div>

<h1>血壓/用藥紀錄表</h1>

<div class="filter-section">
    <button class="add-btn" onclick="addRecord()">新增紀錄</button>
    <button class="add-btn" onclick="downloadCSV()">下載CSV</button>
    <button class="add-btn" style="background-color:#e1f5fe;" onclick="toggleChart(true)">顯示數據分析</button>
    <button class="add-btn" style="background-color:#f1f8e9;" onclick="toggleCalendar(true)">顯示月曆檢視</button>
    <button class="add-btn" style="background-color:#fff9c4;" onclick="generatePDF()">下載回診報告</button>
    
    <span style="margin-left:15px;">剩餘藥量：</span>
    <input type="number" id="drugStock" value="0" style="width:70px; font-size: 16px; border: 2px solid #448aff;" onchange="updateStock(this.value)"> 顆
    
    <span style="margin-left:15px;">月份篩選：</span>
    <select id="monthFilter" style="padding: 5px;" onchange="loadRecords()"></select>
</div>

<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>日期</th><th>時間</th><th>收縮壓</th><th>舒張壓</th><th>心跳</th><th>備註</th><th>已服藥</th><th>操作</th>
            </tr>
        </thead>
        <tbody id="records"></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const STORAGE_KEY = "bloodPressureRecords";
    const STOCK_KEY = "drugStockCount";
    let chartInstance, weekChartInstance, distChartInstance;
    let calViewDate = new Date();

    const firebaseConfig = {
      apiKey: "AIzaSyB4S2D1GpRME4ZXccqczkUFtqGIfhgjstI",
      authDomain: "my-health-record-1a9f2.firebaseapp.com",
      databaseURL: "https://my-health-record-1a9f2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-health-record-1a9f2",
      storageBucket: "my-health-record-1a9f2.firebasestorage.app",
      messagingSenderId: "884879920046",
      appId: "1:884879920046:web:b3a7505188d0781907163f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dbRef = database.ref("bloodPressureRecords");
    const stockRef = database.ref("drugStockCount");

    function verifyPassword() {
        const pwd = document.getElementById("authPwd").value;
        database.ref("__auth_guard").set({ pwd: pwd })
        .then(() => {
            localStorage.setItem("bp_auth_ok", "1");
            document.getElementById("authLayer").style.display = "none";
            initializeApp();
        })
        .catch(() => { document.getElementById("authMsg").textContent = "密碼錯誤"; });
    }

    if (localStorage.getItem("bp_auth_ok") === "1") {
        document.getElementById("authLayer").style.display = "none";
        window.onload = initializeApp;
    }

    function initializeApp() {
        initMonthFilter();
        loadRecords();
        loadStock(); // 啟動藥量監聽
    }

    // 核心修正：藥量同步與顯示
    function loadStock() {
        stockRef.on("value", snapshot => {
            const val = snapshot.val();
            const stockNum = (val !== null) ? Number(val) : 0;
            
            // 同步到 UI 輸入框
            document.getElementById("drugStock").value = stockNum;
            // 同步到 LocalStorage
            localStorage.setItem(STOCK_KEY, stockNum);
            // 檢查警告顯示
            checkStockAlert(stockNum);
        });
    }

    function updateStock(val) {
        const sCount = Number(val);
        stockRef.set(sCount); // 直接推送到 Firebase，loadStock 的監聽會處理後續 UI 更新
    }

    function checkStockAlert(stock) {
        const reminder = document.getElementById("stockReminder");
        const sCount = Number(stock);
        if (sCount <= 7) {
            reminder.style.display = "block";
            reminder.innerHTML = `⚠️ 藥物剩餘量警告：目前僅剩 <span style="font-size:20px;">${sCount}</span> 顆，請記得回診！`;
        } else {
            reminder.style.display = "none";
        }
    }

    // ---------------- 以下為原有的功能邏輯 ----------------

    function initMonthFilter() {
        const selector = document.getElementById("monthFilter");
        const now = new Date();
        const currentMonth = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, '0');
        if (selector.options.length === 0) {
            const opt = document.createElement("option");
            opt.value = currentMonth; opt.textContent = currentMonth;
            selector.appendChild(opt);
        }
    }

    function loadRecords() {
        dbRef.on("value", snapshot => {
            const data = snapshot.val() || [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateMonthList(data);
            render(data);
        });
    }

    function updateMonthList(data) {
        const selector = document.getElementById("monthFilter");
        const currentVal = selector.value;
        const months = new Set();
        data.forEach(r => { if (r.date) months.add(r.date.substring(0, 7)); });
        const sortedMonths = Array.from(months).sort().reverse();
        selector.innerHTML = "";
        sortedMonths.forEach(m => {
            const opt = document.createElement("option");
            opt.value = m; opt.textContent = m;
            selector.appendChild(opt);
        });
        if (currentVal && months.has(currentVal)) selector.value = currentVal;
        else if (sortedMonths.length > 0) selector.value = sortedMonths[0];
    }

    function getWHOCategory(sys, dia) {
        const s = Number(sys); const d = Number(dia);
        if (!s || !d) return "input-normal";
        if (s >= 160 || d >= 100) return "input-stage2";
        if (s >= 140 || d >= 90) return "input-stage1";
        if (s >= 120 || d >= 80) return "input-elevated";
        return "input-normal";
    }

    function updateSilent(index, key, value, inputElement) {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        
        // 點擊勾選藥物自動扣除/加回庫存
        if (key === 'tookMed') {
            let currentStock = Number(localStorage.getItem(STOCK_KEY)) || 0;
            if (value === true && !data[index].tookMed) {
                currentStock = Math.max(0, currentStock - 1);
                updateStock(currentStock);
            } else if (value === false && data[index].tookMed) {
                currentStock += 1;
                updateStock(currentStock);
            }
        }

        data[index][key] = value;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        dbRef.set(data);
    }

    function render(data) {
        const tbody = document.getElementById("records");
        const filterMonth = document.getElementById("monthFilter").value;
        tbody.innerHTML = "";

        data.forEach((record, index) => {
            if (record.date.substring(0, 7) !== filterMonth) return;
            const tr = document.createElement("tr");
            const whoClass = getWHOCategory(record.sys, record.dia);
            tr.innerHTML = `
                <td><input type="date" value="${record.date}" onchange="updateSilent(${index}, 'date', this.value, this)"></td>
                <td><input type="time" value="${record.time}" onchange="updateSilent(${index}, 'time', this.value, this)"></td>
                <td><input type="number" value="${record.sys}" class="${whoClass}" onchange="updateSilent(${index}, 'sys', this.value, this)"></td>
                <td><input type="number" value="${record.dia}" class="${whoClass}" onchange="updateSilent(${index}, 'dia', this.value, this)"></td>
                <td><input type="number" value="${record.hr}" onchange="updateSilent(${index}, 'hr', this.value, this)"></td>
                <td><input type="text" value="${record.note || ''}" onchange="updateSilent(${index}, 'note', this.value, this)"></td>
                <td><input type="checkbox" ${record.tookMed ? "checked" : ""} onchange="updateSilent(${index}, 'tookMed', this.checked, this)" style="width:20px;height:20px;"></td>
                <td><button onclick="remove(${index})">刪除</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function addRecord() {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        data.push({ date: date, time: time, sys:"", dia:"", hr:"", note:"", tookMed:false });
        dbRef.set(data);
    }

    function remove(index) {
        if (!confirm("確定刪除？")) return;
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        data.splice(index, 1);
        dbRef.set(data);
    }

    // PDF, CSV, Chart, Calendar 函式保持不變...
    function downloadCSV() {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let csv = "日期,時間,收縮壓,舒張壓,心跳,備註,已服藥\n";
        data.forEach(r => csv += `${r.date},${r.time},${r.sys},${r.dia},${r.hr},${r.note},${r.tookMed?'是':'否'}\n`);
        const blob = new Blob(["\uFEFF"+csv], {type:"text/csv;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "血壓紀錄.csv";
        link.click();
    }

    function toggleChart(s) { document.getElementById("chartLayer").style.display = s?"flex":"none"; }
    function toggleCalendar(s) { 
        document.getElementById("calendarLayer").style.display = s?"flex":"none"; 
        if(s) renderCalendar();
    }
    function changeCalMonth(o) { calViewDate.setMonth(calViewDate.getMonth()+o); renderCalendar(); }
    
    function renderCalendar() {
        const grid = document.getElementById("calGrid");
        const title = document.getElementById("calTitle");
        const y = calViewDate.getFullYear();
        const m = calViewDate.getMonth();
        title.textContent = `${y}年 ${m+1}月`;
        grid.innerHTML = "";
        ["日","一","二","三","四","五","六"].forEach(d => {
            const div = document.createElement("div"); div.style.fontWeight="bold"; div.textContent=d; grid.appendChild(div);
        });
        const firstDay = new Date(y, m, 1).getDay();
        const days = new Date(y, m+1, 0).getDate();
        for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement("div"));
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        for(let d=1; d<=days; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const cell = document.createElement("div");
            cell.className = "cal-date-cell";
            if(data.some(r => r.date === dateStr && (Number(r.sys)>=140))) cell.classList.add("bp-high");
            cell.textContent = d;
            grid.appendChild(cell);
        }
    }

    function generatePDF() {
        alert("正在準備報告，請稍候...");
        // 簡化版的 PDF 觸發
        const element = document.body;
        const opt = { margin: 10, filename: '血壓報告.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
        html2pdf().from(element).set(opt).save();
    }
</script>

</body>
</html>
